define(["./normalize"],function(normalize){function indexOf(a,e){for(var i=0,l=a.length;i<l;i++){if(a[i]===e){return i;}}return -1;}if(typeof window=="undefined"){return{load:function(n,r,load){load();}};}var testing=false;var head=document.getElementsByTagName("head")[0];var engine=window.navigator.userAgent.match(/Trident\/([^ ;]*)|AppleWebKit\/([^ ;]*)|Opera\/([^ ;]*)|rv\:([^ ;]*)(.*?)Gecko\/([^ ;]*)|MSIE\s([^ ;]*)/);var hackLinks=false;if(!engine){}else{if(engine[1]||engine[7]){hackLinks=parseInt(engine[1])<6||parseInt(engine[7])<=9;engine="trident";}else{if(engine[2]){hackLinks=true;engine="webkit";}else{if(engine[3]){}else{if(engine[4]){hackLinks=parseInt(engine[4])<18;engine="gecko";}else{if(testing){alert("Engine detection failed");}}}}}}var cssAPI={};cssAPI.pluginBuilder="./css-builder";var curBuffer=[];var onBufferLoad=[];var bufferResources=[];cssAPI.addBuffer=function(resourceId){if(indexOf(curBuffer,resourceId)!=-1){return;}if(indexOf(bufferResources,resourceId)!=-1){return;}curBuffer.push(resourceId);bufferResources.push(resourceId);};cssAPI.setBuffer=function(css,isLess){var pathname=window.location.pathname.split("/");pathname.pop();pathname=pathname.join("/")+"/";var baseParts=require.toUrl("base_url").split("/");baseParts.pop();var baseUrl=baseParts.join("/")+"/";baseUrl=normalize.convertURIBase(baseUrl,pathname,"/");if(baseUrl.substr(0,1)!="/"){baseUrl="/"+baseUrl;}if(baseUrl.substr(baseUrl.length-1,1)!="/"){baseUrl=baseUrl+"/";}cssAPI.inject(normalize(css,baseUrl,pathname));for(var i=0;i<curBuffer.length;i++){if((isLess&&curBuffer[i].substr(curBuffer[i].length-5,5)==".less")||(!isLess&&curBuffer[i].substr(curBuffer[i].length-4,4)==".css")){(function(resourceId){onBufferLoad[resourceId]=onBufferLoad[resourceId]||true;setTimeout(function(){if(typeof onBufferLoad[resourceId]=="function"){onBufferLoad[resourceId]();}delete onBufferLoad[resourceId];},7);})(curBuffer[i]);curBuffer.splice(i--,1);}}};cssAPI.attachBuffer=function(resourceId,load){for(var i=0;i<curBuffer.length;i++){if(curBuffer[i]==resourceId){onBufferLoad[resourceId]=load;return true;}}if(onBufferLoad[resourceId]===true){onBufferLoad[resourceId]=load;return true;}if(bufferResources[resourceId]){load();return true;}};var webkitLoadCheck=function(link,callback){setTimeout(function(){for(var i=0;i<document.styleSheets.length;i++){var sheet=document.styleSheets[i];if(sheet.href==link.href){return callback();}}webkitLoadCheck(link,callback);},10);};var mozillaLoadCheck=function(style,callback){setTimeout(function(){try{style.sheet.cssRules;return callback();}catch(e){}mozillaLoadCheck(style,callback);},10);};if(engine=="trident"&&hackLinks){var ieStyles=[],ieQueue=[],ieStyleCnt=0;var ieLoad=function(url,callback){var style;ieQueue.push({url:url,cb:callback});style=ieStyles.shift();if(!style&&ieStyleCnt++<12){style=document.createElement("style");head.appendChild(style);}ieLoadNextImport(style);};var ieLoadNextImport=function(style){var curImport=ieQueue.shift();if(!curImport){style.onload=noop;ieStyles.push(style);return;}style.onload=function(){curImport.cb(curImport.ss);ieLoadNextImport(style);};var curSheet=style.styleSheet;curImport.ss=curSheet.imports[curSheet.addImport(curImport.url)];};}var createLink=function(url){var link=document.createElement("link");link.type="text/css";link.rel="stylesheet";link.href=url;return link;};var noop=function(){};cssAPI.linkLoad=function(url,callback){var timeout=setTimeout(function(){if(testing){alert("timeout");}callback();},waitSeconds*1000-100);var _callback=function(){clearTimeout(timeout);if(link){link.onload=noop;}setTimeout(callback,7);};if(!hackLinks){var link=createLink(url);link.onload=_callback;head.appendChild(link);}else{if(engine=="webkit"){var link=createLink(url);webkitLoadCheck(link,_callback);head.appendChild(link);}else{if(engine=="gecko"){var style=document.createElement("style");style.textContent='@import "'+url+'"';mozillaLoadCheck(style,_callback);head.appendChild(style);}else{if(engine=="trident"){ieLoad(url,_callback);}}}}};var progIds=["Msxml2.XMLHTTP","Microsoft.XMLHTTP","Msxml2.XMLHTTP.4.0"];var fileCache={};var get=function(url,callback,errback){if(fileCache[url]){callback(fileCache[url]);return;}var xhr,i,progId;if(typeof XMLHttpRequest!=="undefined"){xhr=new XMLHttpRequest();}else{if(typeof ActiveXObject!=="undefined"){for(i=0;i<3;i+=1){progId=progIds[i];try{xhr=new ActiveXObject(progId);}catch(e){}if(xhr){progIds=[progId];break;}}}}xhr.open("GET",url,requirejs.inlineRequire?false:true);xhr.onreadystatechange=function(evt){var status,err;if(xhr.readyState===4){status=xhr.status;if(status>399&&status<600){err=new Error(url+" HTTP status: "+status);err.xhr=xhr;errback(err);}else{fileCache[url]=xhr.responseText;callback(xhr.responseText);}}};xhr.send(null);};var stylesheet=document.createElement("style");stylesheet.type="text/css";head.appendChild(stylesheet);if(stylesheet.styleSheet){cssAPI.inject=function(css){stylesheet.styleSheet.cssText+=css;};}else{cssAPI.inject=function(css){stylesheet.appendChild(document.createTextNode(css));};}var importRegEx=/@import\s*(url)?\s*(('([^']*)'|"([^"]*)")|\(('([^']*)'|"([^"]*)"|([^\)]*))\))\s*;?/g;var pathname=window.location.pathname.split("/");pathname.pop();pathname=pathname.join("/")+"/";var loadCSS=function(fileUrl,callback,errback){if(fileUrl.substr(0,1)!="/"){fileUrl="/"+normalize.convertURIBase(fileUrl,pathname,"/");}get(fileUrl,function(css){css=normalize(css,fileUrl,pathname);var importUrls=[];var importIndex=[];var importLength=[];var match;while(match=importRegEx.exec(css)){var importUrl=match[4]||match[5]||match[7]||match[8]||match[9];importUrls.push(importUrl);importIndex.push(importRegEx.lastIndex-match[0].length);importLength.push(match[0].length);}var completeCnt=0;for(var i=0;i<importUrls.length;i++){(function(i){loadCSS(importUrls[i],function(importCSS){css=css.substr(0,importIndex[i])+importCSS+css.substr(importIndex[i]+importLength[i]);var lenDiff=importCSS.length-importLength[i];for(var j=i+1;j<importUrls.length;j++){importIndex[j]+=lenDiff;}completeCnt++;if(completeCnt==importUrls.length){callback(css);}},errback);})(i);}if(importUrls.length==0){callback(css);}},errback);};cssAPI.normalize=function(name,normalize){if(name.substr(name.length-4,4)==".css"){name=name.substr(0,name.length-4);}return normalize(name);};var waitSeconds;var alerted=false;cssAPI.load=function(cssId,req,load,config,parse){waitSeconds=waitSeconds||config.waitSeconds||7;var resourceId=cssId+(!parse?".css":".less");if(cssAPI.attachBuffer(resourceId,load)){return;}fileUrl=req.toUrl(resourceId);if(!alerted&&testing){alert(hackLinks?"hacking links":"not hacking");alerted=true;}if(!parse){cssAPI.linkLoad(fileUrl,load);}else{if(fileUrl.indexOf(".less")===-1&&parse){fileUrl+=".less";}loadCSS(fileUrl,function(css){if(parse){css=parse(css,function(css){cssAPI.inject(css);setTimeout(load,7);});}});}};if(testing){cssAPI.inspect=function(){if(stylesheet.styleSheet){return stylesheet.styleSheet.cssText;}else{if(stylesheet.innerHTML){return stylesheet.innerHTML;}}};}return cssAPI;});